name: Scheduled Upstream Sync

on:
  schedule:
    - cron: '0 0 */14 * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git User
        uses: fregante/setup-git-user@v2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Fetch Upstream
        id: upstream
        run: |
          git remote add upstream https://github.com/riebl/artery.git
          git fetch upstream master
          echo "hash=$(git rev-parse upstream/master)" >> $GITHUB_OUTPUT

      - name: Check Cache
        id: sync-cache
        uses: actions/cache@v4
        with:
          path: .sync-done
          key: sync-${{ steps.upstream.outputs.hash }}

      - name: Prepare and Merge
        if: steps.sync-cache.outputs.cache-hit != 'true'
        id: sync_logic
        run: |
          git config merge.custom-driver.name "Custom merge driver for Artery/Cavise"
          git config merge.custom-driver.driver "python3 tools/custom_merge.py %O %A %B %P"
          
          BRANCH="sync-upstream-$(date +'%Y-%m-%d')"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          
          if ! git merge upstream/master --no-ff -m "Merge upstream changes $(date +'%Y-%m-%d')"; then
            echo "Attention: Manual resolution required" > conflict_msg.txt
            git add .
            git commit -m "Merge upstream with manual conflicts"
          fi
          
          git push origin "$BRANCH"

          {
            echo "body<<EOF"
            [ -f conflict_msg.txt ] && cat conflict_msg.txt
            echo "Top 5 Upstream Changes"
            echo ""
            git log origin/main..upstream/master --pretty=format:"%h|%s" | while read -r line; do
              hash=$(echo "$line" | cut -d'|' -f1)
              stats=$(git show --shortstat "$hash" | tail -n1)
              added=$(echo "$stats" | grep -oP '\d+(?= insertion)' || echo 0)
              deleted=$(echo "$stats" | grep -oP '\d+(?= deletion)' || echo 0)
              echo "$((added + deleted)) $line"
            done | sort -rn | head -n 5 | awk '{$1=""; print "* " $0}'
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "${{ steps.upstream.outputs.hash }}" > .sync-done

      - name: Create Pull Request
        if: steps.sync-cache.outputs.cache-hit != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "Merge upstream changes ($(date +'%Y-%m-%d'))" \
            --body "${{ steps.sync_logic.outputs.body }}" \
            --base main \
            --head ${{ steps.sync_logic.outputs.branch }}